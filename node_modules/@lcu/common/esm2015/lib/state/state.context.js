import { __awaiter } from "tslib";
import { ObservableContextService } from '../api/observable-context/observable-context.service';
import { Subject, BehaviorSubject, } from 'rxjs';
import { RealTimeConnection } from './../api/real-time/real-time.connection';
import { LCUServiceSettings } from '../api/lcu-service-settings';
import { HttpClient } from '@angular/common/http';
//  TODO:  Need to manage reconnection to hub scenarios here
export class StateContext extends ObservableContextService {
    //  Constructors
    constructor(injector) {
        super();
        this.injector = injector;
        this.connectedToState = new BehaviorSubject({
            Code: -1,
            Message: 'Initialized',
        });
        this.ConnectedToState = this.connectedToState.asObservable();
        this.http = injector.get(HttpClient);
        this.ReconnectionAttempt = new Subject();
        this.Settings = injector.get(LCUServiceSettings);
        const rtUrl = this.buildHubUrl('');
        const actionUrl = this.loadActionUrl('');
        this.rt = new RealTimeConnection(this.http, rtUrl, actionUrl);
        this.rt.ReconnectionAttempt.subscribe((val) => {
            this.ReconnectionAttempt.next(val);
        });
        this.setup();
    }
    //  API Methods
    Execute(action) {
        return this.executeAction(action);
    }
    $Refresh(args = {}) {
        this.Execute({
            Arguments: args,
            Type: 'Refresh',
        });
    }
    Start(shouldUpdate) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.startSub) {
                this.startSub = this.rt.Started.subscribe(() => __awaiter(this, void 0, void 0, function* () {
                    const groupName = yield this.connectToState(shouldUpdate);
                    this.setupReceiveState(groupName);
                    this.connectedToState.next({ Code: 0, Message: 'Success' });
                    this.callRefresh();
                }));
                this.rt.Start();
            }
        });
    }
    //  Helpers
    buildActionUrl(urlRoot) {
        const url = this.loadActionUrl(urlRoot);
        return url;
    }
    buildHubUrl(urlRoot) {
        const url = this.loadHubUrl(urlRoot);
        return url;
    }
    callRefresh() {
        this.$Refresh();
    }
    connectToState(shouldUpdate) {
        return __awaiter(this, void 0, void 0, function* () {
            const stateKey = this.loadStateKey();
            const stateName = this.loadStateName();
            const env = this.loadEnvironment();
            return new Promise((resolve, reject) => {
                this.rt
                    .InvokeAction('ConnectToState', this.loadHeaders(), {
                    ShouldSend: shouldUpdate,
                    Key: stateKey,
                    State: stateName,
                    Environment: env,
                })
                    .subscribe({
                    next: (req) => {
                        if ((req.body.status && req.body.status.code === 0) || (req.body.Status && req.body.Status.Code === 0)) {
                            resolve(req.body.groupName);
                        }
                        else {
                            reject(req.body.status
                                ? req.body.status.message
                                : 'Unknown issue connecting to state.');
                        }
                    },
                    error: (err) => reject(err),
                });
            });
        });
    }
    defaultValue() {
        return {};
    }
    executeAction(action) {
        return __awaiter(this, void 0, void 0, function* () {
            const stateKey = this.loadStateKey();
            const stateName = this.loadStateName();
            return new Promise((resolve, reject) => {
                return this.rt
                    .InvokeAction(action.Type, this.loadHeaders(), Object.assign(Object.assign({}, action), { Key: stateKey, State: stateName }))
                    .subscribe({
                    next: (req) => {
                        resolve(req);
                    },
                    error: (err) => reject(err)
                });
            });
        });
    }
    loadActionPath() {
        const actionRoot = this.loadStateActionRoot();
        return `${actionRoot}`; // ?lcu-app-id=${this.Settings.AppConfig.ID}&lcu-app-ent-lookup=${this.Settings.AppConfig.EnterpriseLookup}`;
    }
    loadActionUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const actionPath = this.loadActionPath();
        return `${apiRoot}${urlRoot || ''}${actionPath}`;
    }
    loadEnvironment() {
        let env = this.Settings.State
            ? this.Settings.State.Environment
            : null;
        if (!env) {
            env = '';
        }
        return env;
    }
    loadHeaders() {
        return {
            'lcu-ent-lookup': this.Settings.Application.EnterpriseLookup,
            'lcu-hub-name': this.loadStateName(),
            'lcu-state-key': this.loadStateKey(),
            'lcu-environment': this.loadEnvironment(),
            'lcu-username-mock': this.loadUsernameMock(),
        };
    }
    loadHubPath() {
        const stateRoot = this.loadStateRoot();
        const env = this.loadEnvironment();
        const unmock = this.loadUsernameMock();
        return `${stateRoot}?lcu-app-ent-lookup=${this.Settings.Application.EnterpriseLookup}&lcu-environment=${env}&lcu-username-mock=${unmock}`;
    }
    loadHubUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const hubPath = this.loadHubPath();
        return `${apiRoot}${urlRoot || ''}${hubPath}`;
    }
    loadStateRoot() {
        const stateRoot = this.Settings.State && this.Settings.State.Root !== undefined
            ? this.Settings.State.Root
            : '';
        return `${stateRoot}/${this.loadStateName()}`;
    }
    loadStateActionRoot() {
        const stateActinRoot = this.Settings.State &&
            this.Settings.State.ActionRoot !== undefined
            ? this.Settings.State.ActionRoot
            : '';
        return `${stateActinRoot}/${this.loadStateName()}`;
    }
    loadUsernameMock() {
        return this.Settings.State && this.Settings.State.UsernameMock
            ? this.Settings.State.UsernameMock
            : '';
    }
    setup() {
        this.Start(false).then();
    }
    setupReceiveState(groupName) {
        this.rt.RegisterHandler(`ReceiveState=>${groupName}`).subscribe((req) => {
            console.log(`Handled state from ${groupName}`);
            this.subject.next(req);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BsY3UvY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3N0YXRlL3N0YXRlLmNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHNEQUFzRCxDQUFDO0FBR2hHLE9BQU8sRUFDTCxPQUFPLEVBR1AsZUFBZSxHQUVoQixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQzdFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQWdCLE1BQU0sc0JBQXNCLENBQUM7QUFHaEUsNERBQTREO0FBRTVELE1BQU0sT0FBZ0IsWUFBZ0IsU0FBUSx3QkFBMkI7SUFtQnZFLGdCQUFnQjtJQUNoQixZQUFzQixRQUFrQjtRQUN0QyxLQUFLLEVBQUUsQ0FBQztRQURZLGFBQVEsR0FBUixRQUFRLENBQVU7UUFHdEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksZUFBZSxDQUFpQjtZQUMxRCxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ1IsT0FBTyxFQUFFLGFBQWE7U0FDdkIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU3RCxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFckMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFFbEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFFakQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVuQyxNQUFN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S0FBSyxDQUFDLFVBQVU7WUFDaEMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUVULE9BQU8sR0FBRyxjQUFjLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUM7SUFDckQsQ0FBQztJQUVTLGdCQUFnQjtRQUN4QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFlBQVk7WUFDNUQsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFlBQVk7WUFDbEMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNULENBQUM7SUFFUyxLQUFLO1FBQ2IsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRVMsaUJBQWlCLENBQUMsU0FBaUI7UUFDM0MsSUFBSSxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsaUJBQWlCLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDdEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsU0FBUyxFQUFFLENBQUMsQ0FBQztZQUUvQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHNpZ25hbFIgZnJvbSAnQGFzcG5ldC9zaWduYWxyJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZUNvbnRleHRTZXJ2aWNlIH0gZnJvbSAnLi4vYXBpL29ic2VydmFibGUtY29udGV4dC9vYnNlcnZhYmxlLWNvbnRleHQuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0YXRlQWN0aW9uIH0gZnJvbSAnLi9zdGF0ZS1hY3Rpb24ubW9kZWwnO1xyXG5pbXBvcnQgeyBJbmplY3RvciwgRXZlbnRFbWl0dGVyLCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtcclxuICBTdWJqZWN0LFxyXG4gIFN1YnNjcmlwdGlvbixcclxuICBmb3JrSm9pbixcclxuICBCZWhhdmlvclN1YmplY3QsXHJcbiAgT2JzZXJ2YWJsZSxcclxufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgUmVhbFRpbWVDb25uZWN0aW9uIH0gZnJvbSAnLi8uLi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5jb25uZWN0aW9uJztcclxuaW1wb3J0IHsgTENVU2VydmljZVNldHRpbmdzIH0gZnJvbSAnLi4vYXBpL2xjdS1zZXJ2aWNlLXNldHRpbmdzJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBTdGF0dXMgfSBmcm9tICcuLi9zdGF0dXMnO1xyXG5cclxuLy8gIFRPRE86ICBOZWVkIHRvIG1hbmFnZSByZWNvbm5lY3Rpb24gdG8gaHViIHNjZW5hcmlvcyBoZXJlXHJcblxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU3RhdGVDb250ZXh0PFQ+IGV4dGVuZHMgT2JzZXJ2YWJsZUNvbnRleHRTZXJ2aWNlPFQ+IHtcclxuICAvLyAgRmllbGRzXHJcbiAgcHJvdGVjdGVkIGNvbm5lY3RlZFRvU3RhdGU6IEJlaGF2aW9yU3ViamVjdDxTdGF0dXM+O1xyXG5cclxuICBwcm90ZWN0ZWQgZ3JvdXBOYW1lOiBzdHJpbmc7XHJcblxyXG4gIHByb3RlY3RlZCBodHRwOiBIdHRwQ2xpZW50O1xyXG5cclxuICBwcm90ZWN0ZWQgcnQ6IFJlYWxUaW1lQ29ubmVjdGlvbjtcclxuXHJcbiAgcHJvdGVjdGVkIHN0YXJ0U3ViOiBTdWJzY3JpcHRpb247XHJcblxyXG4gIC8vICBQcm9wZXJ0aWVzXHJcbiAgcHVibGljIENvbm5lY3RlZFRvU3RhdGU6IE9ic2VydmFibGU8U3RhdHVzPjtcclxuXHJcbiAgcHVibGljIFJlY29ubmVjdGlvbkF0dGVtcHQ6IFN1YmplY3Q8Ym9vbGVhbj47XHJcblxyXG4gIHB1YmxpYyBTZXR0aW5nczogTENVU2VydmljZVNldHRpbmdzO1xyXG5cclxuICAvLyAgQ29uc3RydWN0b3JzXHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLmNvbm5lY3RlZFRvU3RhdGUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFN0YXR1cz4oPFN0YXR1cz57XHJcbiAgICAgIENvZGU6IC0xLFxyXG4gICAgICBNZXNzYWdlOiAnSW5pdGlhbGl6ZWQnLFxyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5Db25uZWN0ZWRUb1N0YXRlID0gdGhpcy5jb25uZWN0ZWRUb1N0YXRlLmFzT2JzZXJ2YWJsZSgpO1xyXG5cclxuICAgIHRoaXMuaHR0cCA9IGluamVjdG9yLmdldChIdHRwQ2xpZW50KTtcclxuXHJcbiAgICB0aGlzLlJlY29ubmVjdGlvbkF0dGVtcHQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xyXG5cclxuICAgIHRoaXMuU2V0dGluZ3MgPSBpbmplY3Rvci5nZXQoTENVU2VydmljZVNldHRpbmdzKTtcclxuXHJcbiAgICBjb25zdCBydFVybCA9IHRoaXMuYnVpbGRIdWJVcmwoJycpO1xyXG5cclxuICAgIGNvbnN0IGFjdGlvblVybCA9IHRoaXMubG9hZEFjdGlvblVybCgnJyk7XHJcblxyXG4gICAgdGhpcy5ydCA9IG5ldyBSZWFsVGltZUNvbm5lY3Rpb24odGhpcy5odHRwLCBydFVybCwgYWN0aW9uVXJsKTtcclxuXHJcbiAgICB0aGlzLnJ0LlJlY29ubmVjdGlvbkF0dGVtcHQuc3Vic2NyaWJlKCh2YWw6IGJvb2xlYW4pID0+IHtcclxuICAgICAgdGhpcy5SZWNvbm5lY3Rpb25BdHRlbXB0Lm5leHQodmFsKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuc2V0dXAoKTtcclxuICB9XHJcblxyXG4gIC8vICBBUEkgTWV0aG9kc1xyXG4gIHB1YmxpYyBFeGVjdXRlKGFjdGlvbjogU3RhdGVBY3Rpb24pIHtcclxuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVBY3Rpb24oYWN0aW9uKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyAkUmVmcmVzaChhcmdzOiBhbnkgPSB7fSkge1xyXG4gICAgdGhpcy5FeGVjdXRlKHtcclxuICAgICAgQXJndW1lbnRzOiBhcmdzLFxyXG4gICAgICBUeXBlOiAnUmVmcmVzaCcsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBTdGFydChzaG91bGRVcGRhdGU6IGJvb2xlYW4pIHtcclxuICAgIGlmICghdGhpcy5zdGFydFN1Yikge1xyXG4gICAgICB0aGlzLnN0YXJ0U3ViID0gdGhpcy5ydC5TdGFydGVkLnN1YnNjcmliZShhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZ3JvdXBOYW1lID0gYXdhaXQgdGhpcy5jb25uZWN0VG9TdGF0ZShzaG91bGRVcGRhdGUpO1xyXG5cclxuICAgICAgICB0aGlzLnNldHVwUmVjZWl2ZVN0YXRlKGdyb3VwTmFtZSk7XHJcblxyXG4gICAgICAgIHRoaXMuY29ubmVjdGVkVG9TdGF0ZS5uZXh0KDxTdGF0dXM+eyBDb2RlOiAwLCBNZXNzYWdlOiAnU3VjY2VzcycgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuY2FsbFJlZnJlc2goKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLnJ0LlN0YXJ0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAgSGVscGVyc1xyXG4gIHByb3RlY3RlZCBidWlsZEFjdGlvblVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHVybCA9IHRoaXMubG9hZEFjdGlvblVybCh1cmxSb290KTtcclxuXHJcbiAgICByZXR1cm4gdXJsO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGJ1aWxkSHViVXJsKHVybFJvb3Q6IHN0cmluZykge1xyXG4gICAgY29uc3QgdXJsID0gdGhpcy5sb2FkSHViVXJsKHVybFJvb3QpO1xyXG5cclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgY2FsbFJlZnJlc2goKSB7XHJcbiAgICB0aGlzLiRSZWZyZXNoKCk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYXN5bmMgY29ubmVjdFRvU3RhdGUoc2hvdWxkVXBkYXRlOiBib29sZWFuKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgIGNvbnN0IHN0YXRlS2V5ID0gdGhpcy5sb2FkU3RhdGVLZXkoKTtcclxuIFxyXG4gICAgY29uc3Qgc3RhdGVOYW1lID0gdGhpcy5sb2FkU3RhdGVOYW1lKCk7XHJcbiBcclxuICAgIGNvbnN0IGVudiA9IHRoaXMubG9hZEVudmlyb25tZW50KCk7XHJcbiBcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdGhpcy5ydFxyXG4gICAgICAgIC5JbnZva2VBY3Rpb24oJ0Nvbm5lY3RUb1N0YXRlJywgdGhpcy5sb2FkSGVhZGVycygpLCB7XHJcbiAgICAgICAgICBTaG91bGRTZW5kOiBzaG91bGRVcGRhdGUsXHJcbiAgICAgICAgICBLZXk6IHN0YXRlS2V5LFxyXG4gICAgICAgICAgU3RhdGU6IHN0YXRlTmFtZSxcclxuICAgICAgICAgIEVudmlyb25tZW50OiBlbnYsXHJcbiAgICAgICAgfSlcclxuICAgICAgICAuc3Vic2NyaWJlKHtcclxuICAgICAgICAgIG5leHQ6IChyZXE6IEh0dHBSZXNwb25zZTxhbnk+KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICgocmVxLmJvZHkuc3RhdHVzICYmIHJlcS5ib2R5LnN0YXR1cy5jb2RlID09PSAwKSB8fCAocmVxLmJvZHkuU3RhdHVzICYmIHJlcS5ib2R5LlN0YXR1cy5Db2RlID09PSAwKSkge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUocmVxLmJvZHkuZ3JvdXBOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICAgICAgICByZXEuYm9keS5zdGF0dXNcclxuICAgICAgICAgICAgICAgICAgPyByZXEuYm9keS5zdGF0dXMubWVzc2FnZVxyXG4gICAgICAgICAgICAgICAgICA6ICdVbmtub3duIGlzc3VlIGNvbm5lY3RpbmcgdG8gc3RhdGUuJ1xyXG4gICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBlcnJvcjogKGVycikgPT4gcmVqZWN0KGVyciksXHJcbiAgICAgICAgICAvLyBjb21wbGV0ZTogKCkgPT4gY29uc29sZS5sb2coJ09ic2VydmVyIGdvdCBhIGNvbXBsZXRlIG5vdGlmaWNhdGlvbicpLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZGVmYXVsdFZhbHVlKCk6IFQge1xyXG4gICAgcmV0dXJuIDxUPnt9O1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGFzeW5jIGV4ZWN1dGVBY3Rpb24oYWN0aW9uOiBTdGF0ZUFjdGlvbikge1xyXG4gICAgY29uc3Qgc3RhdGVLZXkgPSB0aGlzLmxvYWRTdGF0ZUtleSgpO1xyXG4gXHJcbiAgICBjb25zdCBzdGF0ZU5hbWUgPSB0aGlzLmxvYWRTdGF0ZU5hbWUoKTtcclxuIFxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPG9iamVjdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICByZXR1cm4gdGhpcy5ydFxyXG4gICAgICAgIC5JbnZva2VBY3Rpb24oYWN0aW9uLlR5cGUsIHRoaXMubG9hZEhlYWRlcnMoKSwge1xyXG4gICAgICAgICAgLi4uYWN0aW9uLFxyXG4gICAgICAgICAgS2V5OiBzdGF0ZUtleSxcclxuICAgICAgICAgIFN0YXRlOiBzdGF0ZU5hbWUsXHJcbiAgICAgICAgfSlcclxuICAgICAgICAuc3Vic2NyaWJlKHtcclxuICAgICAgICAgIG5leHQ6IChyZXE6IEh0dHBSZXNwb25zZTxhbnk+KSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUocmVxKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBlcnJvcjogKGVycikgPT4gcmVqZWN0KGVycilcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRBY3Rpb25QYXRoKCkge1xyXG4gICAgY29uc3QgYWN0aW9uUm9vdCA9IHRoaXMubG9hZFN0YXRlQWN0aW9uUm9vdCgpO1xyXG5cclxuICAgIHJldHVybiBgJHthY3Rpb25Sb290fWA7IC8vID9sY3UtYXBwLWlkPSR7dGhpcy5TZXR0aW5ncy5BcHBDb25maWcuSUR9JmxjdS1hcHAtZW50LWxvb2t1cD0ke3RoaXMuU2V0dGluZ3MuQXBwQ29uZmlnLkVudGVycHJpc2VMb29rdXB9YDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkQWN0aW9uVXJsKHVybFJvb3Q6IHN0cmluZykge1xyXG4gICAgY29uc3QgYXBpUm9vdCA9IHRoaXMuU2V0dGluZ3MgPyB0aGlzLlNldHRpbmdzLkFQSVJvb3QgfHwgJycgOiAnJztcclxuXHJcbiAgICBjb25zdCBhY3Rpb25QYXRoID0gdGhpcy5sb2FkQWN0aW9uUGF0aCgpO1xyXG5cclxuICAgIHJldHVybiBgJHthcGlSb290fSR7dXJsUm9vdCB8fCAnJ30ke2FjdGlvblBhdGh9YDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkRW52aXJvbm1lbnQoKSB7XHJcbiAgICBsZXQgZW52ID0gdGhpcy5TZXR0aW5ncy5TdGF0ZVxyXG4gICAgICA/IHRoaXMuU2V0dGluZ3MuU3RhdGUuRW52aXJvbm1lbnRcclxuICAgICAgOiBudWxsO1xyXG5cclxuICAgIGlmICghZW52KSB7XHJcbiAgICAgIGVudiA9ICcnO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBlbnY7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEhlYWRlcnMoKTogeyBbaGVhZGVyOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXSB9IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICdsY3UtZW50LWxvb2t1cCc6IHRoaXMuU2V0dGluZ3MuQXBwbGljYXRpb24uRW50ZXJwcmlzZUxvb2t1cCxcclxuICAgICAgJ2xjdS1odWItbmFtZSc6IHRoaXMubG9hZFN0YXRlTmFtZSgpLFxyXG4gICAgICAnbGN1LXN0YXRlLWtleSc6IHRoaXMubG9hZFN0YXRlS2V5KCksXHJcbiAgICAgICdsY3UtZW52aXJvbm1lbnQnOiB0aGlzLmxvYWRFbnZpcm9ubWVudCgpLFxyXG4gICAgICAnbGN1LXVzZXJuYW1lLW1vY2snOiB0aGlzLmxvYWRVc2VybmFtZU1vY2soKSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEh1YlBhdGgoKSB7XHJcbiAgICBjb25zdCBzdGF0ZVJvb3QgPSB0aGlzLmxvYWRTdGF0ZVJvb3QoKTtcclxuXHJcbiAgICBjb25zdCBlbnYgPSB0aGlzLmxvYWRFbnZpcm9ubWVudCgpO1xyXG5cclxuICAgIGNvbnN0IHVubW9jayA9IHRoaXMubG9hZFVzZXJuYW1lTW9jaygpO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZVJvb3R9P2xjdS1hcHAtZW50LWxvb2t1cD0ke3RoaXMuU2V0dGluZ3MuQXBwbGljYXRpb24uRW50ZXJwcmlzZUxvb2t1cH0mbGN1LWVudmlyb25tZW50PSR7ZW52fSZsY3UtdXNlcm5hbWUtbW9jaz0ke3VubW9ja31gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRIdWJVcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBhcGlSb290ID0gdGhpcy5TZXR0aW5ncyA/IHRoaXMuU2V0dGluZ3MuQVBJUm9vdCB8fCAnJyA6ICcnO1xyXG5cclxuICAgIGNvbnN0IGh1YlBhdGggPSB0aGlzLmxvYWRIdWJQYXRoKCk7XHJcblxyXG4gICAgcmV0dXJuIGAke2FwaVJvb3R9JHt1cmxSb290IHx8ICcnfSR7aHViUGF0aH1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGxvYWRTdGF0ZUtleSgpOiBzdHJpbmc7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBsb2FkU3RhdGVOYW1lKCk6IHN0cmluZztcclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRTdGF0ZVJvb3QoKSB7XHJcbiAgICBjb25zdCBzdGF0ZVJvb3QgPVxyXG4gICAgICB0aGlzLlNldHRpbmdzLlN0YXRlICYmIHRoaXMuU2V0dGluZ3MuU3RhdGUuUm9vdCAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgPyB0aGlzLlNldHRpbmdzLlN0YXRlLlJvb3RcclxuICAgICAgICA6ICcnO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZVJvb3R9LyR7dGhpcy5sb2FkU3RhdGVOYW1lKCl9YDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkU3RhdGVBY3Rpb25Sb290KCkge1xyXG4gICAgY29uc3Qgc3RhdGVBY3RpblJvb3QgPVxyXG4gICAgICB0aGlzLlNldHRpbmdzLlN0YXRlICYmXHJcbiAgICAgIHRoaXMuU2V0dGluZ3MuU3RhdGUuQWN0aW9uUm9vdCAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgPyB0aGlzLlNldHRpbmdzLlN0YXRlLkFjdGlvblJvb3RcclxuICAgICAgICA6ICcnO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZUFjdGluUm9vdH0vJHt0aGlzLmxvYWRTdGF0ZU5hbWUoKX1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRVc2VybmFtZU1vY2soKSB7XHJcbiAgICByZXR1cm4gdGhpcy5TZXR0aW5ncy5TdGF0ZSAmJiB0aGlzLlNldHRpbmdzLlN0YXRlLlVzZXJuYW1lTW9ja1xyXG4gICAgICA/IHRoaXMuU2V0dGluZ3MuU3RhdGUuVXNlcm5hbWVNb2NrXHJcbiAgICAgIDogJyc7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc2V0dXAoKSB7XHJcbiAgICB0aGlzLlN0YXJ0KGZhbHNlKS50aGVuKCk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc2V0dXBSZWNlaXZlU3RhdGUoZ3JvdXBOYW1lOiBzdHJpbmcpIHtcclxuICAgIHRoaXMucnQuUmVnaXN0ZXJIYW5kbGVyKGBSZWNlaXZlU3RhdGU9PiR7Z3JvdXBOYW1lfWApLnN1YnNjcmliZSgocmVxKSA9PiB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBIYW5kbGVkIHN0YXRlIGZyb20gJHtncm91cE5hbWV9YCk7XHJcblxyXG4gICAgICB0aGlzLnN1YmplY3QubmV4dChyZXEpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==